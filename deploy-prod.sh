#!/bin/bash

# ============================================================================
# –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –°–ö–†–ò–ü–¢ –î–ï–ü–õ–û–Ø –î–õ–Ø PRODUCTION
# ============================================================================
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy-prod.sh [--clean]
#
# –û–ø—Ü–∏–∏:
#   --clean   –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è node_modules) - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö
#
# –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç:
#   1. –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–¥ –∏–∑ git
#   2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
#   3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Prisma Client
#   4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö)
#   5. –°–æ–±–∏—Ä–∞–µ—Ç Next.js –≤ standalone —Ä–µ–∂–∏–º–µ
#   6. –ö–æ–ø–∏—Ä—É–µ—Ç —Å—Ç–∞—Ç–∏–∫—É –¥–ª—è standalone
#   7. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç PM2
# ============================================================================

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

# ============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ò–ó–ú–ï–ù–ò–¢–ï –ü–û–î –°–í–û–ô –°–ï–†–í–ï–†
# ============================================================================
PROJECT_DIR="/var/www/burker-watches.ru"
APP_NAME="burker-watches"
PORT=3010
NODE_PATH="/root/.nvm/versions/node/v24.13.1/bin/node"

# –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–í–ê–ñ–ù–û –¥–ª—è standalone —Ä–µ–∂–∏–º–∞!)
DATABASE_PATH="${PROJECT_DIR}/prisma/dev.db"
DATABASE_URL="file:${DATABASE_PATH}"

# ============================================================================
# –¶–í–ï–¢–ê –î–õ–Ø –í–´–í–û–î–ê
# ============================================================================
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[‚úì]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[!]${NC} $1"; }
log_error() { echo -e "${RED}[‚úó]${NC} $1"; }

# ============================================================================
# –ü–†–û–í–ï–†–ö–ê –ê–†–ì–£–ú–ï–ù–¢–û–í
# ============================================================================
CLEAN_BUILD=false
if [ "$1" == "--clean" ]; then
    CLEAN_BUILD=true
    log_warn "–†–µ–∂–∏–º –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –≤–∫–ª—é—á—ë–Ω"
fi

# ============================================================================
# –ù–ê–ß–ê–õ–û –î–ï–ü–õ–û–Ø
# ============================================================================
echo ""
echo "============================================================================"
echo "  –î–ï–ü–õ–û–ô ${APP_NAME} –ù–ê PRODUCTION"
echo "  $(date '+%Y-%m-%d %H:%M:%S')"
echo "============================================================================"
echo ""

cd "${PROJECT_DIR}"
log_info "–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${PROJECT_DIR}"

# ============================================================================
# 1. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê
# ============================================================================
echo ""
log_info "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ git..."
git fetch origin main
git reset --hard origin/main
log_success "–ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω"

# ============================================================================
# 2. –û–ß–ò–°–¢–ö–ê –°–¢–ê–†–´–• –§–ê–ô–õ–û–í
# ============================================================================
echo ""
log_info "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏..."
rm -rf .next
rm -rf node_modules/.cache
rm -rf .turbo

if [ "$CLEAN_BUILD" = true ]; then
    log_warn "–£–¥–∞–ª–µ–Ω–∏–µ node_modules –¥–ª—è —á–∏—Å—Ç–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    rm -rf node_modules
fi
log_success "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# ============================================================================
# 3. –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
# ============================================================================
echo ""
log_info "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install --legacy-peer-deps
log_success "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# ============================================================================
# 4. PRISMA - –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–õ–ò–ï–ù–¢–ê
# ============================================================================
echo ""
log_info "üóÑÔ∏è  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma Client..."
npx prisma generate
log_success "Prisma Client —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"

# ============================================================================
# 5. –ë–ê–ó–ê –î–ê–ù–ù–´–•
# ============================================================================
echo ""
log_info "üóÑÔ∏è  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
if [ ! -f "${DATABASE_PATH}" ]; then
    log_warn "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ${DATABASE_PATH}"
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ä—ã–π –ø—É—Ç—å (–Ω–∞ —Å–ª—É—á–∞–π –º–∏–≥—Ä–∞—Ü–∏–∏)
    OLD_DB_PATH="${PROJECT_DIR}/prisma/prisma/dev.db"
    if [ -f "${OLD_DB_PATH}" ]; then
        log_info "–ù–∞–π–¥–µ–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–∞—Ä–æ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–∏, –∫–æ–ø–∏—Ä—É—é..."
        cp "${OLD_DB_PATH}" "${DATABASE_PATH}"
        log_success "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞"
    else
        log_warn "–°–æ–∑–¥–∞—é –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
    fi
fi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ñ–∞–π–ª –ë–î –Ω–µ –ø—É—Å—Ç–æ–π
if [ -f "${DATABASE_PATH}" ] && [ ! -s "${DATABASE_PATH}" ]; then
    log_warn "–§–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–æ–π, —É–¥–∞–ª—è—é..."
    rm -f "${DATABASE_PATH}"
fi

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É (–±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö)
export DATABASE_URL="${DATABASE_URL}"
npx prisma db push --skip-generate

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ -f "${DATABASE_PATH}" ]; then
    DB_SIZE=$(ls -lh "${DATABASE_PATH}" | awk '{print $5}')
    log_success "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: ${DATABASE_PATH} (${DB_SIZE})"
    
    # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã
    echo ""
    log_info "–¢–∞–±–ª–∏—Ü—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:"
    sqlite3 "${DATABASE_PATH}" ".tables" 2>/dev/null || log_warn "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã"
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
    PRODUCT_COUNT=$(sqlite3 "${DATABASE_PATH}" "SELECT COUNT(*) FROM Product;" 2>/dev/null || echo "0")
    log_info "–¢–æ–≤–∞—Ä–æ–≤ –≤ –±–∞–∑–µ: ${PRODUCT_COUNT}"
else
    log_error "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–∑–¥–∞–Ω–∞!"
    exit 1
fi

# ============================================================================
# 6. –°–ë–û–†–ö–ê NEXT.JS
# ============================================================================
echo ""
log_info "üèóÔ∏è  –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (Next.js standalone)..."
npm run build
log_success "–°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# ============================================================================
# 7. –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –°–¢–ê–¢–ò–ö–ò –î–õ–Ø STANDALONE
# ============================================================================
echo ""
log_info "üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏ –¥–ª—è standalone —Ä–µ–∂–∏–º–∞..."

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ standalone –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if [ ! -d ".next/standalone" ]; then
    log_error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .next/standalone –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ next.config.ts"
    exit 1
fi

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏–∫—É
mkdir -p .next/standalone/.next
cp -r .next/static .next/standalone/.next/
log_success "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: .next/static ‚Üí .next/standalone/.next/static"

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å public (–µ—Å–ª–∏ –µ—Å—Ç—å)
if [ -d "public" ]; then
    cp -r public .next/standalone/
    log_success "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: public ‚Üí .next/standalone/public"
else
    log_warn "–ü–∞–ø–∫–∞ public –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ (—ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
fi

# –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å prisma –¥–ª—è standalone (–Ω—É–∂–µ–Ω –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π)
mkdir -p .next/standalone/prisma
cp prisma/schema.prisma .next/standalone/prisma/
log_success "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: prisma/schema.prisma"

# ============================================================================
# 8. –û–ß–ò–°–¢–ö–ê DEV –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞)
# ============================================================================
echo ""
log_info "üßπ –û—á–∏—Å—Ç–∫–∞ dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm prune --production 2>/dev/null || npm prune --omit=dev 2>/dev/null || true
log_success "Dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–¥–∞–ª–µ–Ω—ã"

# ============================================================================
# 9. –ü–ï–†–ï–ó–ê–ü–£–°–ö PM2
# ============================================================================
echo ""
log_info "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2..."

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å
pm2 stop "${APP_NAME}" 2>/dev/null || true
pm2 delete "${APP_NAME}" 2>/dev/null || true

# –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–º–ø—ã PM2 (—á—Ç–æ–±—ã –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã)
rm -f /root/.pm2/dump.pm2
rm -f /root/.pm2/dump.pm2.bak

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏
pm2 flush 2>/dev/null || true

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
pm2 start ecosystem.config.js
log_success "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ"

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
pm2 save
log_success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PM2 —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞"

# ============================================================================
# 10. –ü–†–û–í–ï–†–ö–ê –†–ê–ë–û–¢–û–°–ü–û–°–û–ë–ù–û–°–¢–ò
# ============================================================================
echo ""
log_info "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏..."
sleep 3

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å PM2
pm2 status

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ—Ç–≤–µ—á–∞–µ—Ç –ª–∏ —Å–µ—Ä–≤–µ—Ä
echo ""
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP-–æ—Ç–≤–µ—Ç–∞..."
HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${PORT}/" 2>/dev/null || echo "000")

if [ "$HTTP_STATUS" == "200" ]; then
    log_success "–°–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç: HTTP ${HTTP_STATUS}"
else
    log_warn "–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª: HTTP ${HTTP_STATUS}"
    log_info "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: pm2 logs ${APP_NAME} --lines 50"
fi

# ============================================================================
# 11. –ò–¢–û–ì–û–í–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
# ============================================================================
echo ""
echo "============================================================================"
echo -e "${GREEN}  –î–ï–ü–õ–û–ô –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û!${NC}"
echo "============================================================================"
echo ""
echo "  üìå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:     ${APP_NAME}"
echo "  üìå –ü–æ—Ä—Ç:           ${PORT}"
echo "  üìå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:    ${DATABASE_PATH}"
echo "  üìå –°—Ç–∞—Ç—É—Å:         http://localhost:${PORT}/"
echo ""
echo "  –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "    pm2 logs ${APP_NAME} --lines 50    # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏"
echo "    pm2 status                          # –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
echo "    pm2 restart ${APP_NAME}            # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å"
echo "    pm2 monit                           # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
echo ""
echo "============================================================================"
