# Сборка проекта

## Обычная сборка

```bash
npm run build
```

## Если сборка падает или вёрстка ломается

### 1. Чистая сборка (без кэша Next.js)

Удаляет `.next`, заново генерирует Prisma-клиент и собирает проект:

```bash
npm run build:clean
```

### 2. Полная чистая сборка (кэш Next.js и webpack)

Дополнительно очищает кэш в `node_modules/.cache`:

```bash
npm run build:full
```

### 3. Ручная последовательность (максимальный сброс)

Выполняйте по порядку, если скриптов недостаточно:

```bash
# Очистка артефактов сборки и кэшей
rm -rf .next
rm -rf node_modules/.cache

# Генерация Prisma-клиента (обязательно перед сборкой)
npx prisma generate

# Сборка в режиме production
NODE_ENV=production npm run build
```

### 4. «Ядерный» вариант (переустановка зависимостей)

Если сборка всё ещё падает (ошибки зависимостей, несовместимые версии):

```bash
# Удалить сборку и зависимости
rm -rf .next node_modules

# Установить зависимости строго по lockfile (рекомендуется на проде)
npm ci

# Сгенерировать Prisma-клиент и собрать
npx prisma generate
NODE_ENV=production npm run build
```

**Важно:** после `npm ci` все пакеты ставятся заново по `package-lock.json`. Не используйте `npm install` вместо `npm ci` на проде, если нужна предсказуемая сборка.

## На проде после сборки

- Приложение в режиме `standalone` лежит в `.next/standalone/`. Запуск: `node .next/standalone/server.js` из корня проекта (или из папки `standalone` с правильным `cwd`).
- Статика: `.next/static` копируется в `standalone` при сборке. Папка `public` тоже копируется в `.next/standalone/public/` — если после сборки вы добавляете файлы в `public/products/`, либо настройте nginx на раздачу из `public/products/`, либо создайте симлинк (см. документацию по деплою).

## Типичные ошибки при сборке

| Ошибка | Действие |
|--------|----------|
| `PrismaClient is not able to run in the browser` | Выполнить `npx prisma generate` и пересобрать. |
| 404 на `_next/static/chunks/` после деплоя | Сборка и статика от разных билдов. Сделать `rm -rf .next`, затем заново `npm run build` и перезапустить приложение из той же директории. |
| `Module not found` / странные ошибки импорта | Выполнить вариант 4 (переустановка через `npm ci` и полная пересборка). |
| Сломанная вёрстка при работающем сайте | Проверить, что нет 404 на CSS в Network. Если есть — полная пересборка и рестарт одного и того же билда. |
