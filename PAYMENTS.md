# Оплата заказов (T-Bank СБП B2B)

Интеграция одноразовых ссылок на оплату через СБП. Документация T-Bank: [СБП B2B](https://developer.tbank.ru/docs/products/sbp-b2b), [выпуск токена](https://developer.tbank.ru/docs/intro/manuals/self-service-auth).

## Переменные окружения

- `TBANK_TERMINAL` — номер терминала (для теста из ЛК Т-Бизнес).
- `TBANK_PASSWORD` — пароль терминала.
- `TBANK_ACCOUNT_NUMBER` — расчётный счёт юрлица/ИП (20 или 22 цифры).
- `TBANK_BASE_URL` — опционально; по умолчанию `https://invoicing-int.tinkoff.ru` (песочница).
- `TBANK_TOKEN` — опционально; Bearer-токен вместо пары терминал/пароль (например `TBankSandboxToken` для песочницы).

Для продакшена задайте боевые значения и при необходимости смените `TBANK_BASE_URL` на боевой URL по документации T-Bank.

## Подключение вебхука

1. Эндпоинт для уведомлений: `POST https://<ваш-домен>/api/webhooks/tbank`.
2. Зарегистрируйте URL в T-Bank: напишите на [openapi@tbank.ru](mailto:openapi@tbank.ru), укажите ИНН компании, URL вебхука и при необходимости данные для авторизации.
3. Сервер проверяет IP отправителя (белый список: `212.233.80.7`, `91.218.132.2`).

## Сценарий

1. Пользователь оформляет заказ → создаётся заказ и одноразовая ссылка T-Bank.
2. Редирект на страницу оплаты `/order/<id>/pay` (кнопка «Перейти к оплате»).
3. После оплаты в СБП T-Bank вызывает вебхук → заказ переводится в статус «Оплачен», заполняется `paidAt`.
4. Пользователь возвращается по `redirectUrl` на страницу подтверждения заказа.

## Деплой

После выката кода с интеграцией оплаты на сервере нужно обновить схему БД (в таблице `Order` должны появиться колонки `paymentStatus`, `paymentId`, `paymentLink`, `paidAt`):

- Если используете миграции: `npx prisma migrate deploy`
- Иначе: `npx prisma db push`

Без этого при создании заказа будет ошибка: *The column `paymentStatus` does not exist*.

## Тестирование

Используйте тестовый терминал и пароль из личного кабинета Т-Бизнес (песочница). В production не используйте тестовые учёты.
