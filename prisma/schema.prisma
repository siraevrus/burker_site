// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Product {
  id              String   @id @default(cuid())
  bodyId          String?  @unique // body_id из JSON для использования в URL
  name            String
  collection      String
  subcategory     String?  // Подкатегория из JSON (Diana, Sophie, Браслеты, и т.д.)
  bestseller      Boolean  @default(false) // Флаг бестселлера из JSON
  price           Float
  originalPrice   Float
  discount        Int
  colors          String   // JSON array as string: ["золото", "серебро"]
  images          String   // JSON array as string: ["/image1.jpg", "/image2.jpg"]
  inStock         Boolean  @default(true)
  soldOut         Boolean  @default(false) // Товар распродан (Sold_out: 1 = распродан, 0 = в наличии)
  disabled        Boolean  @default(false) // Отключенный товар не отображается на сайте
  variant         String?
  rating          Float?
  reviewsCount    Int?
  description     String?
  specifications  String?  // JSON object as string
  relatedProducts String?  // JSON array as string
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PromoBanner {
  id          String   @id @default(cuid())
  image       String
  productLink String?
  title       String?
  subtitle    String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Page {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  content   String
  category  String?  // "customer-service" или "policies"
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TopBanner {
  id        String   @id @default("single")
  text      String
  updatedAt DateTime @updatedAt
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String   // bcrypt hash
  emailVerified Boolean  @default(false)
  firstName     String?
  lastName      String?
  phone         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  orders             Order[]
  emailVerifications EmailVerification[]
}

model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  code      String   // 6-значный код
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User?    @relation(fields: [email], references: [email], onDelete: Cascade)
  
  @@index([email])
}

model Order {
  id              String      @id @default(cuid())
  orderNumber     String?     @unique // Читаемый номер заказа: burker_YYYYMMDDHHmmss_userId_orderId_XXX
  userId          String?     // null для гостевых заказов
  email           String      // обязательное поле
  firstName       String
  lastName        String      // обязательное поле
  middleName      String      // Отчество (обязательное поле)
  phone           String
  address         String?     // адрес доставки (опционально)
  cdekAddress     String      // Адрес ПВЗ СДЕК (обязательное поле)
  cdekPointCode   String?     // Код ПВЗ СДЭК (для накладной)
  city            String?
  postalCode      String?
  country         String?     @default("Россия")
  comment         String?     // комментарий к заказу
  
  // Данные для таможенного оформления
  inn             String      // ИНН (обязательное поле)
  passportSeries  String     // Серия паспорта (обязательное поле)
  passportNumber  String     // Номер паспорта (обязательное поле)
  passportIssueDate String   // Дата выдачи паспорта (обязательное поле)
  passportIssuedBy String    // Кем выдан паспорт (обязательное поле)
  requiresConfirmation Boolean @default(false) // Требуется ли связаться для подтверждения заказа
  promoCode        String?   // Промокод, примененный к заказу
  promoDiscount    Float?    @default(0) // Сумма скидки по промокоду
  
  status          String      @default("pending") // pending, confirmed, shipped, delivered, cancelled
  totalAmount     Float
  shippingCost    Float       @default(5.0)
  
  items           OrderItem[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model OrderItem {
  id               String   @id @default(cuid())
  orderId          String
  productId        String
  productName      String   // snapshot на момент заказа
  productPrice     Float    // snapshot цены в RUB
  originalPriceEur Float?   // оригинальная цена в EUR (для расчета вознаграждения комиссионера)
  selectedColor    String
  quantity         Int
  
  order            Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model ExchangeRate {
  id        String   @id @default("current")
  eurRate   Float    // Курс EUR к USD
  rubRate   Float    // Курс RUB к USD
  updatedAt DateTime @updatedAt
}

model PromoCode {
  id          String   @id @default(cuid())
  code        String   @unique // Уникальный код промокода
  discount    Float    // Сумма скидки в рублях
  validFrom   DateTime // Дата начала действия
  validUntil  DateTime // Дата окончания действия
  isActive    Boolean  @default(true) // Активен ли промокод
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique // Email подписчика
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Feedback {
  id          String   @id @default(cuid())
  name        String   // Имя
  contact     String   // Контакт (ТГ или телефон)
  comment     String   // Комментарий
  processed   Boolean  @default(false) // Сообщение отработано
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
