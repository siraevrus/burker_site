# Настройка автоматического импорта 3 раза в день

Автоматический импорт товаров настроен на выполнение 3 раза в день: **8:00, 14:00, 20:00 UTC**.

## Варианты настройки

### 1. Vercel (автоматически)

Если проект развернут на **Vercel**, cron настроен через `vercel.json`. Чтобы вызовы не отклонялись:

1. **Добавьте переменную окружения в Vercel:**  
   Project → Settings → Environment Variables → добавьте переменную **`CRON_SECRET`** (имя именно такое — Vercel передаёт его в заголовке при вызове cron).  
   Значение: случайная строка не короче 16 символов (например, сгенерируйте в 1Password или `openssl rand -hex 32`).

2. **Передеплойте проект** после добавления переменной.

3. **Проверка:** Vercel Dashboard → Cron Jobs → убедитесь, что задача есть; при необходимости откройте логи вызова (View Logs).

**Ограничение тарифа Hobby:** на бесплатном плане cron может запускаться **только 1 раз в день**. Расписание «3 раза в день» будет работать только на платных планах (Pro и выше). На Hobby измените в `vercel.json` расписание на одно срабатывание в день, например `"0 12 * * *"`.

---

### 2. Внешний cron сервис (рекомендуется для других платформ)

Используйте внешние сервисы для вызова API endpoint:

#### Вариант A: Использовать `/api/cron/import` (с защитой)

**URL для вызова:**
```
GET https://ваш-домен.ru/api/cron/import?secret=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ
```

**Или с заголовком:**
```
GET https://ваш-домен.ru/api/cron/import
Authorization: Bearer ВАШ_СЕКРЕТНЫЙ_КЛЮЧ
```

**Переменные окружения** (достаточно одной):
- **`CRON_SECRET`** — используется Vercel при вызове cron (подставьте тот же ключ в настройках проекта).
- **`CRON_SECRET_KEY`** — альтернатива для внешних cron (например, cron-job.org).

#### Вариант B: Использовать `/api/admin/import/auto` (с защитой)

**URL для вызова:**
```
GET https://ваш-домен.ru/api/admin/import/auto?secret=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ
```

**Или с заголовком:**
```
GET https://ваш-домен.ru/api/admin/import/auto
Authorization: Bearer ВАШ_СЕКРЕТНЫЙ_КЛЮЧ
```

⚠️ **Важно:** если `CRON_SECRET` настроен, endpoint отклонит любой запрос без корректного секрета (401).

---

### 3. Настройка через внешние сервисы

#### Cron-job.org (бесплатный)

1. Зарегистрируйтесь на https://cron-job.org
2. Создайте новую задачу:
   - **URL:** `https://ваш-домен.ru/api/cron/import?secret=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ`
   - **Расписание:** `0 8,14,20 * * *` (3 раза в день: 8:00, 14:00, 20:00 UTC)
   - **Метод:** GET

#### EasyCron

1. Зарегистрируйтесь на https://www.easycron.com
2. Создайте cron job с теми же параметрами

#### UptimeRobot (мониторинг + cron)

1. Зарегистрируйтесь на https://uptimerobot.com
2. Создайте HTTP(s) Monitor с расписанием

---

### 4. Настройка на собственном сервере (Linux)

Если у вас есть доступ к серверу, настройте cron через crontab:

```bash
# Откройте crontab для редактирования
crontab -e

# Добавьте строку (замените URL и секретный ключ):
0 8,14,20 * * * curl -X GET "https://ваш-домен.ru/api/cron/import?secret=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ" > /dev/null 2>&1
```

**Или с логированием:**
```bash
0 8,14,20 * * * curl -X GET "https://ваш-домен.ru/api/cron/import?secret=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ" >> /var/log/import-cron.log 2>&1
```

---

### 5. Docker / Kubernetes

Если используете Docker или Kubernetes, можно создать отдельный контейнер с cron:

**Dockerfile для cron:**
```dockerfile
FROM alpine:latest
RUN apk add --no-cache curl
COPY cron-import.sh /cron-import.sh
RUN chmod +x /cron-import.sh
CMD crond -f -l 2
```

**cron-import.sh:**
```bash
#!/bin/sh
curl -X GET "https://ваш-домен.ru/api/cron/import?secret=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ"
```

**crontab в контейнере:**
```
0 8,14,20 * * * /cron-import.sh
```

---

## Расписание cron

Формат: `минута час день месяц день_недели`

- `0 8,14,20 * * *` = в 8:00, 14:00 и 20:00 UTC каждый день
- `0 11,17,23 * * *` = в 11:00, 17:00 и 23:00 UTC (для московского времени +3 часа)

**Конвертация времени:**
- UTC 8:00 = МСК 11:00
- UTC 14:00 = МСК 17:00
- UTC 20:00 = МСК 23:00

---

## Проверка работы

После настройки проверьте логи:

1. **Vercel:** Dashboard → Functions → Logs
2. **Внешний cron:** Логи на сайте сервиса cron
3. **Собственный сервер:** Проверьте логи приложения или `/var/log/`

**Тестовый вызов:**
```bash
curl -X GET "https://ваш-домен.ru/api/cron/import?secret=ВАШ_СЕКРЕТНЫЙ_КЛЮЧ"
```

Должен вернуться JSON с результатом импорта.

---

## Безопасность

⚠️ **Важно:** Обязательно установите переменную окружения `CRON_SECRET_KEY` и используйте защищенный endpoint `/api/cron/import` для внешних cron сервисов.
